name: Build Kernel

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up build environment
        run: |
          sudo apt-get update
          sudo apt-get install -y repo git-core gnupg flex bison gperf build-essential \
            zip curl zlib1g-dev gcc-multilib g++-multilib libc6-dev-i386 \
            lib32ncurses5-dev x11proto-core-dev libx11-dev lib32z-dev ccache \
            libgl1-mesa-dev libxml2-utils xsltproc unzip

      - name: Initialize repo
        run: |
          mkdir -p ~/bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          export PATH=~/bin:$PATH
          repo init -u https://github.com/sn33kyb33v3r/ElementOS-manifest-mirror.git -b master
          repo sync -c -j$(nproc) --force-sync kernel/samsung/exynos990

      - name: Checkout submodules
        run: |
          git submodule update --init --recursive

      - name: Build kernel
        run: |
          cd kernel/samsung/exynos990
          make element_r8s_defconfig
          make -j$(nproc) Image.gz-dtb

      - name: Upload kernel artifact
        uses: actions/upload-artifact@v4
        with:
          name: kernel-image
          path: kernel/samsung/exynos990/arch/arm64/boot/Image.gz-dtb
